<div class="page-controls">
  <div class="page-info">
    <span class="page-title">Page {{pageNumber}}</span>
  </div>

  <div class="page-layout-control">
    <label>Layout:</label>
    <select hx-put="/novels/{{novelId}}/page/{{pageNumber}}/layout"
            hx-swap="none"
            hx-trigger="change"
            hx-on::after-request="if(event.detail.successful) window.location.reload()"
            name="layout">
      <option value="full" {{#if isFullLayout}}selected{{/if}}>Full Page</option>
      <option value="two-panel" {{#if isTwoPanelLayout}}selected{{/if}}>Two Panels</option>
      <option value="three-panel" {{#if isThreePanelLayout}}selected{{/if}}>Three Panels</option>
      <option value="four-grid" {{#if isFourGridLayout}}selected{{/if}}>Four Grid</option>
      <option value="six-grid" {{#if isSixGridLayout}}selected{{/if}}>Six Grid</option>
    </select>
  </div>

  <button class="btn btn-small btn-danger"
          hx-delete="/novels/{{novelId}}/page/{{pageNumber}}"
          hx-confirm="Delete this page?"
          hx-swap="none"
          hx-on::after-request="if(event.detail.successful) window.location.href='/novels/{{novelId}}'">
    Delete Page
  </button>
</div>

<div class="page-canvas layout-{{layoutTemplate}}">
  {{#each panels}}
  <div class="panel" id="panel-{{panelIndex}}">
    {{#if hasImage}}
    <img src="{{imageUrl}}" alt="Panel {{panelIndex}}" class="panel-image">
    <div class="panel-overlay">
      <button class="btn btn-small btn-secondary regenerate-btn"
              onclick="this.closest('.panel').querySelector('.panel-prompt-form').style.display = 'block'; this.closest('.panel-overlay').style.display = 'none';">
        Regenerate
      </button>
    </div>
    <div class="panel-caption-container">
      <input type="text" value="{{caption}}"
             hx-put="/novels/{{novelId}}/page/{{pageNumber}}/panel/{{panelIndex}}/caption"
             hx-trigger="blur, keyup[key=='Enter']"
             hx-swap="none"
             name="caption"
             placeholder="Add caption..."
             class="panel-caption-input">
    </div>
    <form class="panel-prompt-form" style="display: none;"
          hx-post="/novels/{{novelId}}/page/{{pageNumber}}/panel/{{panelIndex}}/generate"
          hx-target="#panel-{{panelIndex}}"
          hx-swap="innerHTML">
      <textarea name="prompt" placeholder="Describe this panel..." class="panel-prompt-input">{{prompt}}</textarea>
      <div class="panel-prompt-actions">
        <button type="button" class="btn btn-small btn-secondary"
                onclick="this.closest('.panel-prompt-form').style.display = 'none'; this.closest('.panel').querySelector('.panel-overlay').style.display = 'flex';">
          Cancel
        </button>
        <button type="submit" class="btn btn-small btn-primary">Generate</button>
      </div>
    </form>
    {{else if isGenerating}}
    <div class="panel-generating">
      <div class="spinner"></div>
      <span>Generating...</span>
    </div>
    {{else if isError}}
    <div class="panel-error">
      <span class="error-icon">!</span>
      <p>Generation failed</p>
      <form hx-post="/novels/{{novelId}}/page/{{pageNumber}}/panel/{{panelIndex}}/generate"
            hx-target="#panel-{{panelIndex}}"
            hx-swap="innerHTML"
            class="panel-prompt-form">
        <textarea name="prompt" placeholder="Describe this panel..." class="panel-prompt-input">{{prompt}}</textarea>
        <button type="submit" class="btn btn-small btn-primary">Retry</button>
      </form>
    </div>
    {{else}}
    <div class="panel-empty">
      <form hx-post="/novels/{{novelId}}/page/{{pageNumber}}/panel/{{panelIndex}}/generate"
            hx-target="#panel-{{panelIndex}}"
            hx-swap="innerHTML"
            class="panel-prompt-form">
        <textarea name="prompt" placeholder="Describe this panel..." class="panel-prompt-input"></textarea>
        <button type="submit" class="btn btn-small btn-primary">Generate</button>
      </form>
    </div>
    {{/if}}
  </div>
  {{/each}}
</div>
