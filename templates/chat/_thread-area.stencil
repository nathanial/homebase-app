<div class="chat-message-area">
  <div class="chat-message-header-bar">
    <h2 class="chat-current-title">{{activeThread.title}}</h2>
    <div class="chat-message-actions">
      <button class="btn-icon"
              hx-get="/chat/thread/{{activeThread.id}}/edit"
              hx-target="#modal-container"
              hx-swap="innerHTML">Edit</button>
      <button class="btn-icon btn-icon-danger"
              hx-delete="/chat/thread/{{activeThread.id}}"
              hx-target="#chat-container"
              hx-swap="innerHTML"
              hx-confirm="Delete thread '{{activeThread.title}}' and all its messages?">Delete</button>
    </div>
  </div>
  <div id="messages-list" class="chat-messages-list">
    {{#each messages}}
    <div id="message-{{id}}" class="chat-message">
      <div class="chat-message-header">
        <span class="chat-message-author">{{userName}}</span>
        <span class="chat-message-time">{{relativeTime}}</span>
      </div>
      <div class="chat-message-content">
        {{#each contentLines}}
        <p>{{this}}</p>
        {{/each}}
      </div>
      {{#if hasEmbeds}}
      <div class="chat-embeds">
        {{#each embeds}}
        <div class="chat-embed chat-embed-{{embedType}}">
          {{#if isYoutube}}
          <a href="{{url}}" target="_blank" class="chat-embed-youtube-link">
            <div class="chat-embed-youtube-thumb">
              <img src="{{thumbnailUrl}}" alt="{{title}}">
              <div class="chat-embed-play-icon">‚ñ∂</div>
            </div>
            {{#if hasTitle}}
            <div class="chat-embed-youtube-info">
              <div class="chat-embed-title">{{title}}</div>
            </div>
            {{/if}}
          </a>
          {{else}}
          {{#if isTwitter}}
          <a href="{{url}}" target="_blank" class="chat-embed-twitter-link">
            <div class="chat-embed-twitter-header">
              <span class="chat-embed-twitter-icon">ùïè</span>
              {{#if hasAuthor}}<span class="chat-embed-twitter-author">{{authorName}}</span>{{/if}}
            </div>
            {{#if hasDescription}}<div class="chat-embed-twitter-text">{{description}}</div>{{/if}}
            {{#if hasThumbnail}}<img src="{{thumbnailUrl}}" alt="" class="chat-embed-twitter-image">{{/if}}
          </a>
          {{else}}
          <a href="{{url}}" target="_blank" class="chat-embed-generic-link">
            {{#if hasThumbnail}}<img src="{{thumbnailUrl}}" alt="" class="chat-embed-generic-thumb">{{/if}}
            <div class="chat-embed-generic-info">
              {{#if hasTitle}}<div class="chat-embed-title">{{title}}</div>{{/if}}
              {{#if hasDescription}}<div class="chat-embed-description">{{description}}</div>{{/if}}
            </div>
          </a>
          {{/if}}
          {{/if}}
        </div>
        {{/each}}
      </div>
      {{/if}}
      {{#if hasAttachments}}
      <div class="chat-attachments">
        {{#each attachments}}
        {{#if isImage}}
        <a href="{{url}}" target="_blank" class="chat-attachment-image">
          <img src="{{url}}" alt="{{fileName}}" class="chat-attachment-thumbnail">
        </a>
        {{else}}
        <a href="{{url}}" download="{{fileName}}" class="chat-attachment-file">
          <span class="chat-attachment-icon">üìé</span>
          <span class="chat-attachment-name">{{fileName}}</span>
          <span class="chat-attachment-size">{{fileSizeFormatted}}</span>
        </a>
        {{/if}}
        {{/each}}
      </div>
      {{/if}}
    </div>
    {{/each}}
  </div>
  <form id="message-form"
        hx-post="/chat/thread/{{activeThread.id}}/message"
        hx-target="#messages-list"
        hx-swap="beforeend"
        hx-on::after-request="afterMessageSubmit(this)">
    <input type="hidden" name="_csrf" value="{{csrfToken}}">
    <input type="hidden" name="attachments" id="attachments-input" value="">
    <input type="file" id="file-input" class="chat-file-input"
           multiple="true" accept="image/*,.pdf,.txt"
           onchange="handleFileSelect(this.files)"
           data-thread-id="{{activeThread.id}}">
    <div id="upload-preview" class="chat-upload-preview"></div>
    <div class="chat-input-container" id="chat-input-drop-zone"
         ondragover="handleDragOver(event)"
         ondragleave="handleDragLeave(event)"
         ondrop="handleInputDrop(event)">
      <textarea name="content" id="message-content" class="chat-input"
                placeholder="Type a message or drop files here..." rows="2"
                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitMessageWithAttachments(); }"></textarea>
      <button type="button" class="chat-attach-btn"
              onclick="document.getElementById('file-input').click()"
              title="Attach files">üìé</button>
      <button type="submit" class="chat-send-btn"
              onclick="event.preventDefault(); submitMessageWithAttachments()">Send</button>
    </div>
  </form>
</div>
